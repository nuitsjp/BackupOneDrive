# Start-Immich.ps1 - Dynamically generated by Install-Immich.ps1

. "$PSScriptRoot\Modules\Functions.ps1"

$DistroName = $script:DistroName
$WSLUserName = $script:WSLUserName
$AppPort = 2283

$ErrorActionPreference = 'Stop'

function Write-Log {
    param(
        [string]$Message,
        [ValidateSet('INFO','WARN','ERROR')][string]$Level = 'INFO'
    )
    Write-Host "[Start-Immich] $Message"
}

Write-Log "Immichの起動プロセスを開始します..."

try {
    Write-Log "WSLディストロ '$DistroName' が実行中であることを確認し、キープアライブを開始します..."
    wsl -d $DistroName --exec dbus-launch true
    Write-Log "WSLディストロ '$DistroName' のキープアライブを開始しました。"    # WSLのIPアドレスが変わることを考慮してport-proxy設定を更新
    Write-Log "現在のWSL IPアドレスでポートプロキシ設定を更新しています..."
    Set-ImmichPortProxy -AppPort $AppPort
    Set-ImmichFirewallRule -AppPort $AppPort
    
    # サービス起動前に少し待機
    Start-Sleep -Seconds 5
    
    Write-Log "'$script:ImmichDirWSL' でImmichサービスを '$WSLUserName' ユーザーとして起動しています..."
    $WslCommand = "cd '$script:ImmichDirWSL' && docker compose pull && docker compose up -d"
    
    Write-Log "WSLで実行: wsl -d $DistroName -u $WSLUserName -- bash -c $WslCommand"
    wsl -d $DistroName -u $WSLUserName -- bash -c "$WslCommand"
    Write-Log "'$DistroName' でImmichサービスの起動コマンドを実行しました。"

} catch {
    Write-Log "Immichの起動中にエラーが発生しました: $($_.Exception.Message) | スタックトレース: $($_.ScriptStackTrace)" -Level ERROR
    exit 1
}

Write-Log "Start-Immich.ps1 が正常に完了しました。"
exit 0
