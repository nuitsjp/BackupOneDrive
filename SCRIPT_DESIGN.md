# スクリプト設計方針

## 基本方針

### エラーハンドリング
- **単純な停止方式**: エラー発生時は全体を中断し、再実行は先頭から行う
- **冪等性の担保**: 同じスクリプトを何度実行しても安全になるよう設計
- **ロールバック不要**: アンインストール用スクリプトを別途用意して対応
- **既存設定の上書き**: 既存の設定ファイルは確認なしで上書き

### 対象環境
- **OS**: Ubuntu 24.04 LTS固定
- **ディストリビューション変更対応**: 変数による共通定義で将来的な変更に対応
- **WSL/Linuxサーバー差異**: 必要に応じて環境判定で分岐処理

### 設定管理
- **デフォルト値**: スクリプト内にハードコード
- **機密情報**: 当面はデフォルト値を使用（Immich PostgreSQLパスワードなど）
- **設定ファイル**: .envファイルでの管理、後々カスタマイズ対応

### UI/UX
- **プログレス表示**: 各パッケージの標準出力に任せてシンプルに実装
- **中断・再開機能**: 実装しない
- **対話モード**: 最初に必要な入力をまとめて取得、その後は自動実行

## アーキテクチャ

### ディレクトリ構造
```
scripts/
├── setup.sh                 # メインエントリーポイント
├── uninstall.sh             # メインアンインストールスクリプト
├── lib/
│   ├── common.sh            # 共通ライブラリ（ログ、ユーティリティ）
│   └── config.sh            # 設定管理ライブラリ
├── install/
│   ├── install-docker.sh    # Docker インストール
│   ├── install-immich.sh    # Immich セットアップ
│   ├── install-jellyfin.sh  # Jellyfin セットアップ
│   ├── install-cloudflared.sh # Cloudflare Tunnel セットアップ
│   └── install-rclone.sh    # rclone セットアップ
├── uninstall/
│   ├── uninstall-docker.sh
│   ├── uninstall-immich.sh
│   ├── uninstall-jellyfin.sh
│   ├── uninstall-cloudflared.sh
│   └── uninstall-rclone.sh
├── deploy/
│   ├── deploy-all.sh        # 全サービス一括デプロイ
│   └── generate-configs.sh  # 設定ファイル自動生成
└── sync/
    └── sync-cloud-storage.sh # クラウドストレージ同期
```

> 現状のフォルダ構造は最低限必要なディレクトリに分割していますが、
> 将来的な拡張を見据えつつ現在は可能な限り簡素化しています。

### スクリプト呼び出し方式
```bash
# インストール
# 全体セットアップ（対話モード）
./setup.sh

# カテゴリー別セットアップ
./setup.sh docker
./setup.sh immich
./setup.sh jellyfin
./setup.sh cloudflare
./setup.sh rclone

# 非対話モード（設定済み環境）
./setup.sh all --skip-input
./setup.sh docker --skip-input

# アンインストール
# 全体アンインストール（依存関係逆順）
./uninstall.sh

# カテゴリー別アンインストール
./uninstall.sh docker
./uninstall.sh immich
./uninstall.sh jellyfin
./uninstall.sh cloudflare
./uninstall.sh rclone

# 強制アンインストール（確認スキップ）
./uninstall.sh all --force
./uninstall.sh docker --force
```

## 技術仕様

### 共通ライブラリ機能
- **ログ機能**: カラー付きログ出力（INFO, SUCCESS, WARNING, ERROR, DEBUG）
- **エラーハンドリング**: trap による自動エラー処理
- **ユーティリティ**: コマンド存在確認、サービス状態確認、ディレクトリ作成
- **確認プロンプト**: ユーザー入力での確認機能
- **ヘルスチェック**: SSDディスク状態・容量監視・プロセス稼働状況を定期的にチェックし、
  問題発生時や閾値超過時にはSlackへ通知（今後の実装で対応）

### 設定管理
- **環境変数**: OS情報、パス定義、デフォルト値
- **設定ファイル**: Docker Compose用.env、アプリケーション別設定
- **テンプレート**: 設定ファイルのテンプレート生成

### 冪等性の実装方針
- **インストール済み確認**: コマンド存在、サービス状態での判定
- **設定ファイル確認**: 既存ファイルの上書き（バックアップ付き）
- **サービス状態管理**: 起動済みサービスの適切な処理

## 実装優先順位

### Phase 1: 基盤整備
1. 共通ライブラリ（common.sh, config.sh）
2. メインスクリプト（setup.sh）
3. Docker インストールスクリプト

### Phase 2: アプリケーション
1. Immich セットアップ
2. Jellyfin セットアップ
3. 基本動作確認

### Phase 3: 外部連携
1. Cloudflare Tunnel セットアップ
2. rclone セットアップ
3. 同期スクリプト

### Phase 4: 運用支援
1. アンインストールスクリプト（個別・一括）
2. デプロイスクリプト
3. 監視・ヘルスチェック

## 注意事項

### セキュリティ
- sudo権限が必要な処理の明確化
- 機密情報の適切な取り扱い（将来対応）
- ファイルパーミッションの適切な設定

### 保守性
- コードの可読性重視
- 設定の外部化（将来対応）
- ドキュメントの充実

### 拡張性
- 新しいサービス追加の容易さ
- 異なるOS/ディストリビューションへの対応準備
- 設定カスタマイズの柔軟性

---

この設計方針に基づいて、各スクリプトの実装を進めていきます。
方針変更や追加要件がある場合は、このドキュメントを更新してください。

## アンインストール方針

### 削除順序
依存関係を考慮した逆順での削除：
1. rclone（クラウド同期停止）
2. Cloudflare Tunnel（外部アクセス遮断）
3. Jellyfin（メディアサーバー停止）
4. Immich（写真管理停止）
5. Docker（最後にコンテナ基盤削除）

### データ保護
- **メディアデータ**: 削除前に確認プロンプト（ただし自動バックアップは行わない）

### 安全措置
- **確認プロンプト**: 各段階で削除確認
- **強制モード**: `--force`で確認スキップ
- **部分削除**: サービス単位での選択削除
